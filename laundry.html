<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´—è¡£åŠ©æ‰‹</title>
    <style>
        :root {
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --accent-green: #10b981;
            --accent-orange: #f59e0b; /* è­¦å‘Šè‰² */
            --accent-red: #ef4444;    /* å±é™©è‰² */
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-color: #111827;
            --card-bg: #1f2937;
            --text-main: #f9fafb;
            --text-sub: #9ca3af;
            --primary: #60a5fa;
            --border: #374151;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 15px; }

        /* æ ‡é¢˜æ  */
        header { display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.5rem; }
        .theme-btn { background: none; border: 1px solid var(--border); color: var(--text-main); padding: 6px 10px; border-radius: 8px; cursor: pointer; }

        /* é€šç”¨å¡ç‰‡ */
        .card {
            background-color: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow);
            transition: 0.3s;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }

        /* 1. å¼ºæé†’æ¨¡å¼æ ·å¼ */
        .card.urgent-mode {
            border-color: var(--accent-red);
            background-color: #fef2f2; /* æµ…çº¢èƒŒæ™¯ */
        }
        [data-theme="dark"] .card.urgent-mode { background-color: #3f1a1a; }

        .urgent-banner {
            background-color: var(--accent-red);
            color: white;
            text-align: center;
            padding: 8px;
            font-weight: bold;
            margin: -20px -20px 15px -20px; /* è´´é¡¶ */
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        /* çŠ¶æ€æ˜¾ç¤º */
        .status-box { text-align: center; padding: 25px 10px; }
        .days-count { font-size: 3.5rem; font-weight: 800; line-height: 1; margin: 10px 0; }
        
        /* çŠ¶æ€é¢œè‰² */
        .text-green { color: var(--accent-green); }
        .text-orange { color: var(--accent-orange); }
        .text-red { color: var(--accent-red); }

        .sub-info { display: flex; justify-content: space-around; margin-top: 15px; font-size: 0.9rem; color: var(--text-sub); }
        .sub-info strong { display: block; color: var(--text-main); font-size: 1.1rem; margin-top: 4px; }

        /* ç»Ÿè®¡å»ºè®®æ  */
        .stats-hint {
            background: rgba(59, 130, 246, 0.1);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--primary);
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .apply-btn { font-size: 0.8rem; text-decoration: underline; cursor: pointer; }

        /* æ§åˆ¶åŒº */
        .input-group { margin-bottom: 15px; }
        .input-label { display: block; margin-bottom: 8px; font-weight: 600; }
        
        /* æ ‡ç­¾é€‰æ‹©å™¨ */
        .tags-container { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
        .tag-checkbox { display: none; } /* éšè—åŸç”Ÿcheckbox */
        .tag-label {
            padding: 6px 12px;
            border: 1px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            user-select: none;
            transition: 0.2s;
        }
        .tag-checkbox:checked + .tag-label {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        input[type="number"] { width: 60px; padding: 6px; border-radius: 6px; border: 1px solid var(--border); text-align: center; font-size: 1rem; }

        /* æŒ‰é’®ç»„ */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:active { transform: scale(0.98); }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text-main); }

        /* å†å²åˆ—è¡¨ */
        .history-list { list-style: none; padding: 0; margin: 0; max-height: 250px; overflow-y: auto; }
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        .history-item.today-highlight { background-color: rgba(16, 185, 129, 0.1); padding: 12px 10px; border-radius: 8px; border-bottom: none; margin-bottom: 5px; }
        .h-date { font-weight: 600; font-size: 1rem; }
        .h-tags { font-size: 0.8rem; color: var(--text-sub); display: block; margin-top: 2px; }
        .h-meta { text-align: right; }
        .h-badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; background: #e5e7eb; color: #374151; margin-left: 5px; }
        
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 id="pageTitle">ğŸ§º æ´—è¡£åŠ©æ‰‹</h1>
        <button class="theme-btn" id="themeToggle">ğŸŒ™</button>
    </header>

    <div class="card" id="statusCard">
        <div id="urgentBanner" class="urgent-banner hidden">å·²ç»åˆ°æ—¶é—´å•¦ï¼å¿«å»æ´—è¡£æœï¼ğŸ§º</div>

        <div class="status-box">
            <div id="statusText" class="status-text">è·ç¦»å»ºè®®æ´—è¡£è¿˜æœ‰</div>
            <div class="days-count" id="daysRemaining">--</div>
            <div id="dateDetails" class="sub-info">
                <div>ä¸Šæ¬¡ <strong id="lastDateDisplay">--/--</strong></div>
                <div>å»ºè®® <strong id="nextDateDisplay">--/--</strong></div>
            </div>
        </div>
    </div>

    <div class="card">
        <div id="statsBox" class="stats-hint hidden">
            <span id="statsText">æ­£åœ¨åˆ†æä¹ æƒ¯...</span>
            <span id="applySuggestBtn" class="apply-btn">è®¾ä¸ºå»ºè®®å€¼</span>
        </div>
        
        <div style="margin-top: 15px;"></div>

        <div class="input-group" style="display: flex; align-items: center; justify-content: space-between;">
            <label>ğŸ“… è®¾å®šé—´éš”(å¤©):</label>
            <input type="number" id="intervalInput" value="3" min="1" max="60">
        </div>

        <div class="input-group">
            <label class="input-label">ğŸ·ï¸ æœ¬æ¬¡æ¸…æ´—ç±»å‹ (å¯å¤šé€‰):</label>
            <div class="tags-container">
                <input type="checkbox" id="tag1" class="tag-checkbox" value="è¡£ç‰©" checked>
                <label for="tag1" class="tag-label">ğŸ‘• è¡£ç‰©</label>

                <input type="checkbox" id="tag2" class="tag-checkbox" value="å†…è¡£è¢œ">
                <label for="tag2" class="tag-label">ğŸ§¦ å†…è¡£è¢œ</label>

                <input type="checkbox" id="tag3" class="tag-checkbox" value="åºŠå•è¢«å¥—">
                <label for="tag3" class="tag-label">ğŸ›Œ åºŠå•è¢«å¥—</label>

                <input type="checkbox" id="tag4" class="tag-checkbox" value="æ¯›å·¾">
                <label for="tag4" class="tag-label">ğŸ§£ æ¯›å·¾</label>
                
                <input type="checkbox" id="tag5" class="tag-checkbox" value="è¿åŠ¨">
                <label for="tag5" class="tag-label">ğŸƒ è¿åŠ¨æœ</label>
            </div>
        </div>

        <button class="btn btn-primary" id="recordBtn">âœ¨ è®°å½•ä»Šå¤©æ´—äº†</button>
        
        <div class="btn-grid">
            <button class="btn btn-secondary" id="copyBtn">ğŸ“‹ å¤åˆ¶æé†’</button>
            <button class="btn btn-secondary" id="icsBtn">ğŸ“… å¯¼å‡ºæ—¥å†</button>
        </div>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="margin:0;">å†å²è®°å½•</h3>
            <span style="font-size:0.8rem; color:var(--accent-red); cursor:pointer;" id="clearBtn">æ¸…ç©º</span>
        </div>
        <ul class="history-list" id="historyList"></ul>
    </div>
</div>

<script>
    // === 1. æ•°æ®ç®¡ç†ä¸è¿ç§» ===
    const STORAGE_KEY = 'laundry_app_v2';
    let appData = {
        history: [], // ç»“æ„: [{date: ISOString, tags: []}]
        interval: 3,
        theme: 'light'
    };

    // DOM å¼•ç”¨
    const els = {
        daysRemaining: document.getElementById('daysRemaining'),
        statusText: document.getElementById('statusText'),
        lastDate: document.getElementById('lastDateDisplay'),
        nextDate: document.getElementById('nextDateDisplay'),
        statusCard: document.getElementById('statusCard'),
        urgentBanner: document.getElementById('urgentBanner'),
        recordBtn: document.getElementById('recordBtn'),
        historyList: document.getElementById('historyList'),
        intervalInput: document.getElementById('intervalInput'),
        statsBox: document.getElementById('statsBox'),
        statsText: document.getElementById('statsText'),
        applySuggestBtn: document.getElementById('applySuggestBtn'),
        pageTitle: document.getElementById('pageTitle')
    };

    function init() {
        // å°è¯•è¯»å– V2 æ•°æ®
        const saved = localStorage.getItem(STORAGE_KEY);
        
        // å°è¯•è¯»å–æ—§ç‰ˆ V1 æ•°æ® (å…¼å®¹æ€§è¿ç§»)
        const oldSaved = localStorage.getItem('laundry_app_data');

        if (saved) {
            appData = JSON.parse(saved);
        } else if (oldSaved) {
            // è¿ç§»é€»è¾‘ï¼šå°†æ—§çš„å­—ç¬¦ä¸²æ•°ç»„è½¬ä¸ºå¯¹è±¡æ•°ç»„
            const oldData = JSON.parse(oldSaved);
            appData.interval = oldData.interval;
            appData.theme = oldData.theme;
            appData.history = oldData.history.map(dateStr => ({
                date: dateStr,
                tags: ['è¡£ç‰©(æ—§è®°å½•)']
            }));
            alert("ğŸ‰ å·²è‡ªåŠ¨å‡çº§ä½ çš„å†å²æ•°æ®æ ¼å¼ï¼");
            save(); // ä¿å­˜æ–°æ ¼å¼
        }

        applyTheme(appData.theme);
        els.intervalInput.value = appData.interval;
        render();
        
        // é¡µé¢åŠ è½½æ—¶ï¼Œå¦‚æœè¿‡æœŸï¼Œå¼¹çª—ä¸€æ¬¡
        checkAlertOnLoad();
    }

    function save() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        render();
    }

    // === 2. æ ¸å¿ƒæ¸²æŸ“é€»è¾‘ (å¢å¼ºç‰ˆ) ===
    function render() {
        // A. å¤„ç†å†å²è®°å½•åˆ—è¡¨
        els.historyList.innerHTML = '';
        
        // æ’åºï¼šæ–°åˆ°æ—§
        appData.history.sort((a, b) => new Date(b.date) - new Date(a.date));

        const today = new Date();
        const isTodayRecorded = appData.history.length > 0 && isSameDay(new Date(appData.history[0].date), today);

        appData.history.forEach(item => {
            const date = new Date(item.date);
            const li = document.createElement('li');
            
            // é«˜äº®ä»Šå¤©
            const isToday = isSameDay(date, today);
            li.className = isToday ? 'history-item today-highlight' : 'history-item';
            
            // æ ‡ç­¾æ˜¾ç¤º
            const tagsHtml = item.tags ? item.tags.map(t => `<span class="h-badge">${t}</span>`).join('') : '';
            const tagsText = item.tags ? item.tags.join(', ') : 'è¡£ç‰©';

            li.innerHTML = `
                <div>
                    <div class="h-date">${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ ${isToday ? '<span style="color:var(--accent-green)">(ä»Šå¤©)</span>' : ''}</div>
                    <span class="h-tags">${tagsText}</span>
                </div>
                <div class="h-meta">
                    ${tagsHtml}
                </div>
            `;
            els.historyList.appendChild(li);
        });

        // B. è®¡ç®—çŠ¶æ€
        if (appData.history.length === 0) {
            updateStatusUI('empty');
            return;
        }

        const lastRecord = appData.history[0];
        const lastDate = new Date(lastRecord.date);
        const nextDate = new Date(lastDate);
        nextDate.setDate(lastDate.getDate() + parseInt(appData.interval));
        
        const diffDays = getDaysDiff(today, nextDate);

        // æ›´æ–°æ—¥æœŸæ˜¾ç¤º
        els.lastDate.innerText = formatDate(lastDate);
        els.nextDate.innerText = formatDate(nextDate);

        // C. çŠ¶æ€é€»è¾‘åˆ†æ”¯
        if (diffDays < 0) {
            // --- è¿‡æœŸ (çº¢è‰²æŠ¥è­¦) ---
            const lateDays = Math.abs(diffDays);
            updateStatusUI('overdue', lateDays);
            document.title = `âš ï¸ æ™šäº†${lateDays}å¤© - æ´—è¡£åŠ©æ‰‹`;
        } else if (diffDays === 0) {
            // --- ä»Šå¤© (ç»¿è‰²) ---
            updateStatusUI('today');
            document.title = `âœ… ä»Šå¤©è¯¥æ´— - æ´—è¡£åŠ©æ‰‹`;
        } else if (diffDays === 1) {
            // --- æ˜å¤© (æ©™è‰²é¢„è­¦) ---
            updateStatusUI('warning', 1);
            document.title = `â³ è¿˜å‰©1å¤© - æ´—è¡£åŠ©æ‰‹`;
        } else {
            // --- æœªæ¥ (æ­£å¸¸) ---
            updateStatusUI('normal', diffDays);
            document.title = `æ´—è¡£åŠ©æ‰‹`;
        }

        // D. æ›´æ–°ç»Ÿè®¡
        updateStats();
    }

    // è¾…åŠ©ï¼šUIçŠ¶æ€åˆ‡æ¢æœº
    function updateStatusUI(state, days = 0) {
        // é‡ç½®æ‰€æœ‰ç±»
        els.statusCard.className = 'card';
        els.urgentBanner.classList.add('hidden');
        els.daysRemaining.className = 'days-count';

        switch (state) {
            case 'empty':
                els.statusText.innerText = "è¿˜æ²¡æœ‰è®°å½•";
                els.daysRemaining.innerText = "--";
                break;
            case 'overdue':
                els.statusCard.classList.add('urgent-mode'); // çº¢è‰²è¾¹æ¡†+èƒŒæ™¯
                els.urgentBanner.classList.remove('hidden'); // é¡¶éƒ¨çº¢æ¡
                els.statusText.innerText = "å·²ç»æ™šäº†";
                els.daysRemaining.innerText = days + " å¤©";
                els.daysRemaining.classList.add('text-red');
                break;
            case 'today':
                els.statusText.innerText = "å°±æ˜¯ä»Šå¤©";
                els.daysRemaining.innerText = "Action!";
                els.daysRemaining.classList.add('text-green');
                break;
            case 'warning': // å‰©1å¤©
                els.statusText.innerText = "æ˜å¤©å°±æ˜¯æ´—è¡£æœçš„æ—¥å­";
                els.daysRemaining.innerText = "1 å¤©";
                els.daysRemaining.classList.add('text-orange');
                break;
            case 'normal':
                els.statusText.innerText = "è·ç¦»ä¸‹æ¬¡å»ºè®®æ´—è¡£è¿˜æœ‰";
                els.daysRemaining.innerText = days + " å¤©";
                els.daysRemaining.classList.add('text-green'); // ä½¿ç”¨ç»¿è‰²è¡¨ç¤ºå®‰å…¨
                break;
        }
    }

    // === 3. ç»Ÿè®¡é€»è¾‘ ===
    function updateStats() {
        if (appData.history.length < 2) {
            els.statsBox.classList.add('hidden');
            return;
        }
        els.statsBox.classList.remove('hidden');

        // è®¡ç®—å¹³å‡é—´éš”
        let totalDiff = 0;
        let count = 0;
        // åªå–æœ€è¿‘5æ¬¡è®°å½•æ¥è®¡ç®—ä¹ æƒ¯ï¼Œé¿å…å¤ªä¹…è¿œçš„æ•°æ®å½±å“
        const recentHistory = appData.history.slice(0, 6); 
        
        for (let i = 0; i < recentHistory.length - 1; i++) {
            const d1 = new Date(recentHistory[i].date);
            const d2 = new Date(recentHistory[i+1].date);
            // å› ä¸ºæ˜¯å€’åºï¼Œd1 æ˜¯è¾ƒæ™šçš„æ—¶é—´
            const diff = getDaysDiff(d2, d1); 
            totalDiff += Math.abs(diff);
            count++;
        }

        const avg = Math.round(totalDiff / count);
        
        els.statsText.innerHTML = `ğŸ“Š ä½ çš„å¹³å‡æ´—è¡£å‘¨æœŸæ˜¯ <strong>${avg}</strong> å¤©`;
        
        if (avg !== parseInt(appData.interval)) {
            els.applySuggestBtn.classList.remove('hidden');
            els.applySuggestBtn.onclick = () => {
                appData.interval = avg;
                els.intervalInput.value = avg;
                save(); // é‡æ–°è®¡ç®—å¹¶ä¿å­˜
                alert(`å·²å°†å»ºè®®é—´éš”è°ƒæ•´ä¸º ${avg} å¤©`);
            };
        } else {
            els.applySuggestBtn.classList.add('hidden');
        }
    }

    // === 4. äº¤äº’äº‹ä»¶ ===
    
    els.recordBtn.addEventListener('click', () => {
        const now = new Date();
        
        // **é˜²é‡å¤é€»è¾‘**
        if (appData.history.length > 0) {
            const lastDate = new Date(appData.history[0].date);
            if (isSameDay(lastDate, now)) {
                const confirmOverwrite = confirm("âš ï¸ ä»Šå¤©å·²ç»æœ‰ä¸€æ¡è®°å½•äº†ã€‚\n\nç‚¹å‡»ã€ç¡®å®šã€‘è¦†ç›–æ—§è®°å½•ï¼ˆæ›´æ–°æ ‡ç­¾ï¼‰ã€‚\nç‚¹å‡»ã€å–æ¶ˆã€‘ä¿ç•™åŸæ ·ã€‚");
                if (!confirmOverwrite) return;
                // å¦‚æœè¦†ç›–ï¼Œå…ˆåˆ é™¤ç¬¬ä¸€æ¡
                appData.history.shift();
            }
        }

        // è·å–é€‰ä¸­çš„æ ‡ç­¾
        const selectedTags = Array.from(document.querySelectorAll('.tag-checkbox:checked')).map(cb => cb.value);

        // æ–°å¢è®°å½•å¯¹è±¡
        appData.history.unshift({
            date: now.toISOString(),
            tags: selectedTags.length ? selectedTags : ['è¡£ç‰©']
        });
        
        save();
        
        // æŒ‰é’®åé¦ˆ
        const originalText = els.recordBtn.innerText;
        els.recordBtn.innerText = "âœ… å·²è®°å½•!";
        setTimeout(() => els.recordBtn.innerText = originalText, 1000);
    });

    // é¡µé¢åŠ è½½æ—¶çš„å¼¹çª—æé†’
    function checkAlertOnLoad() {
        if (appData.history.length === 0) return;
        const lastDate = new Date(appData.history[0].date);
        const nextDate = new Date(lastDate);
        nextDate.setDate(lastDate.getDate() + parseInt(appData.interval));
        const diff = getDaysDiff(new Date(), nextDate);
        
        if (diff <= 0) {
            // åªæœ‰å½“ä»Šå¤©ç¬¬ä¸€æ¬¡æ‰“å¼€æ—¶æ‰æé†’ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œæ¯æ¬¡åˆ·æ–°å¦‚æœè¿‡æœŸéƒ½ä¼šæé†’ï¼Œç¬¦åˆâ€œå¼ºæé†’â€éœ€æ±‚ï¼‰
            // ä¸ºäº†ä¸è‡³äºå¤ªçƒ¦äººï¼Œå¯ä»¥ç”¨ setTimeout ç¨å¾®å»¶è¿Ÿä¸€ç‚¹å¼¹å‡º
            setTimeout(() => {
                alert("ğŸ”´ æé†’ï¼š\n\nä½ çš„è¡£æœå·²ç»è¿‡æœŸ " + Math.abs(diff) + " å¤©æ²¡æ´—äº†ï¼\n\nä»Šå¤©è®°å¾—æ´—ï¼");
            }, 500);
        }
    }

    // å…¶ä»–é€šç”¨äº‹ä»¶
    els.intervalInput.addEventListener('change', (e) => {
        appData.interval = parseInt(e.target.value) || 3;
        save();
    });

    document.getElementById('themeToggle').addEventListener('click', () => {
        appData.theme = appData.theme === 'light' ? 'dark' : 'light';
        applyTheme(appData.theme);
        save();
    });

    document.getElementById('clearBtn').addEventListener('click', () => {
        if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) {
            appData.history = [];
            save();
        }
    });

    // å¤åˆ¶æ–‡å­— (æ›´æ–°ä»¥åŒ…å«æ ‡ç­¾)
    document.getElementById('copyBtn').addEventListener('click', () => {
        if (appData.history.length === 0) return;
        const lastItem = appData.history[0];
        const lastTags = lastItem.tags.join('ã€');
        
        const text = `ğŸ§º æ´—è¡£æé†’\nä¸Šæ¬¡æ´—äº†ï¼š${lastTags} (${formatDate(new Date(lastItem.date))})\nå»ºè®®ä»Šå¤©èµ¶ç´§æ´—ï¼`;
        
        navigator.clipboard.writeText(text).then(() => alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'));
    });

    // å·¥å…·å‡½æ•°
    function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        document.getElementById('themeToggle').innerText = theme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
    }

    function getDaysDiff(d1, d2) {
        const date1 = new Date(d1.getFullYear(), d1.getMonth(), d1.getDate());
        const date2 = new Date(d2.getFullYear(), d2.getMonth(), d2.getDate());
        return Math.ceil((date2 - date1) / (1000 * 60 * 60 * 24));
    }

    function isSameDay(d1, d2) {
        return d1.getFullYear() === d2.getFullYear() &&
               d1.getMonth() === d2.getMonth() &&
               d1.getDate() === d2.getDate();
    }

    function formatDate(d) {
        return `${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
    }

    // å¯åŠ¨
    init();
</script>
</body>
</html>